name: Data Pipeline (Templates + Labels)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours

concurrency:
  group: data-pipeline
  cancel-in-progress: true

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    env:
      HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      HOPSWORKS_PROJECT: ${{ secrets.HOPSWORKS_PROJECT }}
      HOPSWORKS_HOST: ${{ secrets.HOPSWORKS_HOST }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install polars pandas gdeltdoc hsfs openai tqdm requests beautifulsoup4 sentence-transformers scikit-learn pillow pydantic

      - name: Generate templates and upload to Hopsworks
        if: env.HOPSWORKS_API_KEY != '' && env.OPENAI_API_KEY != ''
        run: |
          python ml/utils/generate_templates.py \
            --country sweden \
            --total-articles 1000 \
            --llm-batch-size 40 \
            --upload-to-hopsworks \
            --hopsworks-api-key "$HOPSWORKS_API_KEY" \
            --hopsworks-project "${HOPSWORKS_PROJECT:-daily_collage}" \
            ${HOPSWORKS_HOST:+--hopsworks-host "$HOPSWORKS_HOST"}

      - name: Label dataset and upload to Hopsworks
        if: env.HOPSWORKS_API_KEY != ''
        run: |
          python ml/utils/label_dataset.py \
            --articles 500 \
            --country sweden \
            --days-lookback 60 \
            --upload-to-hopsworks \
            --hopsworks-api-key "$HOPSWORKS_API_KEY" \
            --hopsworks-project "${HOPSWORKS_PROJECT:-daily_collage}" \
            ${HOPSWORKS_HOST:+--hopsworks-host "$HOPSWORKS_HOST"} \
            --no-split

      - name: Summary
        run: |
          echo "Templates and labeled dataset steps completed. Fine-tuning is intentionally skipped in CI."
